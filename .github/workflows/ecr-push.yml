name: ECR Push

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ecr-push
  cancel-in-progress: true

permissions:
  id-token: write # OIDC ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã«å¿…è¦
  contents: read

jobs:
  push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (without push)
        id: build
        # imageid is a content-addressable hash of the image config.
        # Used to detect changes; relies on BuildKit producing deterministic
        # image IDs for identical inputs.
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: hackz-server:local
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Restore previous image ID from cache
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: /tmp/docker-imageid
          # Exact key intentionally won't match; restore-keys prefix match
          # fetches the most recent saved entry
          key: docker-imageid-
          restore-keys: docker-imageid-

      - name: Check if image changed
        id: check
        env:
          CURRENT_ID: ${{ steps.build.outputs.imageid }}
        run: |
          echo "Current image ID: $CURRENT_ID"

          if [ -f /tmp/docker-imageid ]; then
            PREVIOUS_ID=$(cat /tmp/docker-imageid)
            echo "Previous image ID: $PREVIOUS_ID"
            if [ "$CURRENT_ID" = "$PREVIOUS_ID" ]; then
              echo "Image unchanged, skipping push"
              echo "changed=false" >> "$GITHUB_OUTPUT"
              echo "### â­ï¸ ECR push skipped" >> "$GITHUB_STEP_SUMMARY"
              echo "Image ID unchanged: \`$CURRENT_ID\`" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "Image changed, will push"
              echo "changed=true" >> "$GITHUB_OUTPUT"
              echo "### ðŸš€ ECR push required" >> "$GITHUB_STEP_SUMMARY"
              echo "Image ID changed" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "No previous image ID found (cache miss), will push"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "### ðŸš€ ECR push required" >> "$GITHUB_STEP_SUMMARY"
            echo "Image ID changed" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        if: steps.check.outputs.changed == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Tag and push Docker image
        if: steps.check.outputs.changed == 'true'
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          REPO: ${{ vars.ECR_REPOSITORY }}
          SHA: ${{ github.sha }}
        run: |
          docker tag hackz-server:local "$REGISTRY/$REPO:$SHA"
          docker tag hackz-server:local "$REGISTRY/$REPO:latest"
          docker push "$REGISTRY/$REPO:$SHA"
          docker push "$REGISTRY/$REPO:latest"

      - name: Deploy to ECS
        if: steps.check.outputs.changed == 'true'
        env:
          ECS_CLUSTER: ${{ vars.ECS_CLUSTER }}
          ECS_SERVICE: ${{ vars.ECS_SERVICE }}
        run: |
          aws ecs update-service \
            --cluster "$ECS_CLUSTER" \
            --service "$ECS_SERVICE" \
            --force-new-deployment

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Seed DynamoDB costumes
        env:
          AWS_REGION: ${{ vars.AWS_REGION }}
        run: bun run packages/server/scripts/seed-costumes.ts

      - name: Write current image ID for cache
        if: steps.check.outputs.changed == 'true'
        env:
          IMAGE_ID: ${{ steps.build.outputs.imageid }}
        run: |
          echo "$IMAGE_ID" > /tmp/docker-imageid

      - name: Save image ID to cache
        if: steps.check.outputs.changed == 'true'
        uses: actions/cache/save@v4
        with:
          path: /tmp/docker-imageid
          key: docker-imageid-${{ github.run_id }}
