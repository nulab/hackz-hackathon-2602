name: AWS Infrastructure Deploy

on:
  push:
    branches: [main]
  workflow_dispatch: # 手動実行を許可（terraform apply の再実行など）

concurrency:
  group: deploy-infra
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_VAR_jwt_secret: ${{ secrets.TF_VAR_JWT_SECRET }}
      TF_VAR_github_access_token: ${{ secrets.TF_VAR_GITHUB_ACCESS_TOKEN }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "$TF_VAR_jwt_secret" ]; then
            echo "ERROR: GitHub Secret TF_VAR_JWT_SECRET is not set"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Create Terraform state bucket if not exists
        run: |
          aws s3api create-bucket \
            --bucket ${{ vars.TF_STATE_BUCKET }} \
            --region ${{ vars.AWS_REGION }} \
            --create-bucket-configuration LocationConstraint=${{ vars.AWS_REGION }} \
          || true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Cache Terraform providers
        uses: actions/cache@v4
        with:
          path: terraform/.terraform/providers
          key: terraform-providers-${{ hashFiles('terraform/.terraform.lock.hcl') }}
          restore-keys: terraform-providers-

      - name: Terraform Init
        run: terraform init -input=false
        working-directory: terraform

      - name: Remove orphaned VPC Origin from Terraform state
        run: |
          if terraform state list 2>/dev/null | grep -q 'aws_cloudfront_vpc_origin'; then
            echo "Removing orphaned VPC Origin from Terraform state..."
            terraform state rm aws_cloudfront_vpc_origin.alb
          else
            echo "No VPC Origin in state, skipping"
          fi
        working-directory: terraform

      - name: Terraform Plan
        run: terraform plan -input=false
        working-directory: terraform

      - name: Terraform Apply
        run: terraform apply -input=false -auto-approve
        working-directory: terraform

      - name: Delete orphaned CloudFront VPC Origin
        run: |
          VPC_ORIGIN_ID="vo_CZFVvJ8qMnTG2jiEz0kqSS"
          ETAG=$(aws cloudfront get-vpc-origin --id "$VPC_ORIGIN_ID" --query 'ETag' --output text 2>/dev/null || true)
          if [ -n "$ETAG" ] && [ "$ETAG" != "None" ]; then
            echo "Deleting orphaned VPC Origin $VPC_ORIGIN_ID..."
            aws cloudfront delete-vpc-origin --id "$VPC_ORIGIN_ID" --if-match "$ETAG" \
              && echo "Successfully deleted VPC Origin" \
              || echo "Warning: VPC Origin deletion failed (may still be in use)"
          else
            echo "VPC Origin not found or already deleted"
          fi
