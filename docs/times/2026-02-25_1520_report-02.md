# 時報レポート #02 — 2026/02/25 15:20

## 前回レポートからの経過

**前回**: 14:10（レポート #01） / **現在**: 15:20 / **経過**: 約1時間10分
**ハッカソン開始からの総経過**: 約3時間35分

---

## タイムライン（14:10 〜 15:20）

| 時刻  | イベント                                                               |
| ----- | ---------------------------------------------------------------------- |
| 14:13 | times #01 レポート投稿、WebRTC 設計ドキュメント作成                    |
| 14:17 | WebRTC 実装計画（9タスク、1346行）作成                                 |
| 14:20 | @hackz/card パッケージ完成（NFC メンバーカード画像生成）               |
| 14:21 | WebRTC プロトコル・シグナリングスキーマ追加                            |
| 14:22 | シグナリング tRPC ルーター実装（ルーム管理）                           |
| 14:24 | ProjectorConnection クラス + React hook                                |
| 14:51 | AdminConnection クラス + React hook                                    |
| 14:52 | QR コードライブラリ追加（qrcode.react, html5-qrcode）                  |
| 14:53 | Projector UI（QR コード表示 + 接続管理画面）                           |
| 14:56 | Admin UI（QR スキャン + NFC 入力画面）                                 |
| 15:00 | lint エラー修正（nested ternary, non-null assertion, exhaustive-deps） |
| 15:07 | auto-generated ファイルのフォーマット修正                              |
| 15:09 | **PR #2 マージ**: WebRTC Admin-Projector 接続                          |

---

## この1時間で完了したこと

### PR #2: WebRTC Admin-Projector 接続 — **マージ完了**

前回レポートで「調査フェーズ / コミットなし」だった `claude/webrtc-connections` が、**設計 → 実装 → マージまで約56分**で完走。+2,901行 / 20ファイルの変更。

#### 実装の全体像

```
Projector (認証済み)          Server (tRPC)           Admin (未認証センサー)
    │                            │                         │
    ├─ createRoom() ────────────▶│                         │
    │◀── roomId ─────────────────│                         │
    │                            │                         │
    │  [QRコード表示: roomId]    │    [QRスキャン: roomId] │
    │                            │◀── joinRoom() ──────────│
    │                            │                         │
    │◀── SSE: admin-joined ──────│                         │
    │                            │                         │
    ├─ createOffer() ──▶ SDP ───▶│──── SSE: offer ────────▶│
    │◀── SSE: answer ◀──────────│◀── createAnswer() ──────│
    │                            │                         │
    │◀═══════════ WebRTC DataChannel (P2P) ═══════════════▶│
    │    NFC_SCANNED, QR_SCANNED, SCAN_RESULT, PING/PONG  │
```

#### レイヤー別の実装内容

**Shared スキーマ（packages/shared/src/）**

- `webrtc-protocol.ts` — upstream/downstream メッセージの Zod スキーマ
  - Upstream（Admin→Projector）: `NFC_SCANNED`, `QR_SCANNED`, `PONG`
  - Downstream（Projector→Admin）: `SCAN_RESULT`, `PING`, `DISCONNECT`
- `signaling-schemas.ts` — ルーム管理・SSE イベントスキーマ

**Server（packages/server/src/trpc/）**

- `rooms.ts` — インメモリルーム管理（Map ベース、1:1 接続強制）
- `routers/signaling.ts` — 6 プロシージャ:
  - `createRoom`（protectedProcedure）/ `joinRoom`（public）
  - `sendSignal`（SDP/ICE 交換）/ `closeRoom`
  - `onSignalForProjector` / `onSignalForAdmin`（SSE subscription）

**Projector アプリ（apps/projector/）**

- `ProjectorConnection` クラス: RTCPeerConnection 管理、5秒 PING / 15秒タイムアウトのハートビート
- `useProjectorConnection` hook: WebRTC + tRPC SSE のライフサイクル管理
- UI: QR コード表示（待機中）→ 接続ステータス（緑バッジ）→ 切断ボタン

**Admin アプリ（apps/admin/）**

- `AdminConnection` クラス: 指数バックオフ再接続（1s→2s→4s→8s→10s、最大5回）
- `useAdminConnection` hook: connect → joinRoom → SSE → offer受信のフロー
- UI: QR スキャン画面 → 接続中スピナー → スキャン待機 + NFC テストボタン

#### 設計上の重要な判断

**「なぜ WebRTC なのか」**: 前回レポートで触れた通信方式の変遷がここで決着。tRPC SSE はサーバー経由の「サーバー → クライアント」一方向通信。Admin ↔ Projector 間の高速双方向通信（NFC スキャン → 即座にプロジェクター反応）には、サーバーを介さない P2P DataChannel が最適という判断。

**「1:1 ルームモデル」**: 1つの Projector に 1つの Admin しか接続できない設計。ハッカソン会場では 1台のプロジェクターに 1台の NFC リーダー端末という物理構成を前提としている。シンプルな制約がシンプルな実装を生む。

**「セキュリティモデル」**: Admin は未認証（公開端末）、Projector は JWT 認証済み。Admin は生の NFC/QR データを送信するだけで、ビジネスロジック判断はすべて Projector 側。「センサーは送るだけ、判断は認証済み端末で」という分離。

---

### @hackz/card パッケージ — **実装完了（未マージ）**

`claude/user-card` ブランチで `packages/card/` として独立パッケージ化が完了。

- Satori（JSX → SVG） → @resvg/resvg-js（SVG → PNG）のパイプライン
- カードデザイン: ピンク → パープルグラデーション、星の装飾、300DPI（1076×650px）
- `generateCardId()`: 紛らわしい文字（0/O, 1/I/L）除外の 10 文字 base32 風 ID
- A4 用紙に 2×4 = 8 枚配置のプレビュー生成確認済み
- **未コミットの変更あり**: デザインリファイン（白背景、アクセントバー、ドットパターン）+ ロゴ統合作業中

---

## ワークストリーム状態サマリ

| #   | ブランチ                                      | 状態                 | 前回からの変化       |
| --- | --------------------------------------------- | -------------------- | -------------------- |
| 1   | `claude/data-modeling`                        | **マージ済み**       | 変化なし             |
| 2   | `claude/webrtc-connections`                   | **マージ済み**       | 調査中 → **完了**    |
| 3   | `claude/user-card`                            | 実装済み（未マージ） | デザインリファイン中 |
| 4   | `claude/implement-admin-app`                  | 実装済み（未マージ） | 変化なし（統合待ち） |
| 5   | `claude/investigate-dancing-video-generation` | 調査フェーズ         | 変化なし             |
| 6   | `claude/gh-pages`                             | **新規** 待機中      | 新しく作成           |

### 統合の課題: admin-app ブランチ

`claude/implement-admin-app`（レポート#01 時点で実装済み）は、tRPC SSE 経由の NFC/QR 通信を前提に作られている。PR #2 で WebRTC が入った今、Admin の通信層を SSE → WebRTC DataChannel に差し替える統合作業が必要。コード内の `// TODO: Replace with WebRTC response from projector` がその接合点を示している。

---

## PRD 進捗マッピング（更新）

| PRD 機能              | 優先度       | 状態                                       | 前回比 |
| --------------------- | ------------ | ------------------------------------------ | ------ |
| NFC 読み取り          | Must         | **実装済み**（admin アプリ + WebRTC 連携） | →      |
| ユーザー認証          | Must         | **実装済み**（JWT, tRPC middleware）       | →      |
| Admin ↔ Projector通信 | Must         | **実装済み**（WebRTC DataChannel）         | **↑**  |
| メンバーカード生成    | —            | **実装済み**（@hackz/card パッケージ）     | **↑**  |
| マイページ            | Must         | テンプレートに雛形あり、未着手             | →      |
| ガチャ                | Must         | tRPC router あり、フロント未実装           | →      |
| 写真アップロード      | Must         | tRPC router あり、フロント未実装           | →      |
| 顔検出・合成          | Must         | **未着手**（調査ブランチにコミットなし）   | →      |
| ダンス動画表示        | Must         | **未着手**                                 | →      |
| 衣装一覧              | Must         | データモデル完了、フロント未実装           | →      |
| 衣装構築              | Must         | データモデル完了、フロント未実装           | →      |
| ノーツ＆スコア        | Should       | 未着手                                     | →      |
| リザルト              | Should       | 未着手                                     | →      |
| 3D モデルプレビュー   | Nice to Have | 未着手                                     | →      |

---

## この1時間の振り返り

### スピード感: 設計から実装・マージまで56分

WebRTC は「難しい技術」の代名詞だが、以下の戦略で高速に実装できている:

1. **設計ドキュメント先行**: 1346行の実装計画を最初に作成し、タスク分割を明確化
2. **tRPC シグナリング**: WebSocket サーバーを別途立てず、既存の tRPC SSE をシグナリングに流用
3. **DataChannel 限定**: メディアストリーム（映像・音声）は使わず、テキストメッセージの DataChannel のみ。複雑な STUN/TURN 設定も最小限
4. **物理制約からの設計**: 「1台のプロジェクターに1台の端末」という会場レイアウトから 1:1 ルームモデルを導出

### 並列開発の成果

worktree が6本に増加。うち2本がマージ済み、2本が実装完了で統合待ち。「設計ドキュメント → 実装 → PR → マージ」のサイクルが安定して回り始めている。

### 最大のリスクは変わらず

`claude/investigate-dancing-video-generation` にまだコミットがない。インフラ（通信・データモデル・管理画面・カード）は着実に進んでいるが、プロダクトの核心機能（「え、自分がアイドルになってる」）の技術検証が未着手のまま。ハッカソン残り時間を考えると、そろそろここに集中すべきタイミング。

---

## 次の時報までの見通し

- **最優先**: ダンス動画合成の技術検証（Bedrock 顔検出 or 代替アプローチ）
- admin-app ブランチの WebRTC 統合 → マージ
- user-card ブランチのデザイン確定 → マージ
- mobile アプリ（マイページ・ガチャ UI）着手の可否判断

---

_このレポートは 2026/02/25 15:20 時点の git log、worktree 状態、コード内容、前回レポートとの差分から生成されました。_
