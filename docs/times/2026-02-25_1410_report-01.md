# 時報レポート #01 — 2026/02/25 14:10

## ハッカソン開始からの経過

**開始**: 11:45 / **現在**: 14:10 / **経過**: 約2時間25分

---

## タイムライン

| 時刻  | イベント                                                       |
| ----- | -------------------------------------------------------------- |
| 11:45 | Initial commit + テンプレートからのプロジェクトセットアップ    |
| 〜    | （設計・方針議論フェーズ）                                     |
| 12:57 | admin アプリ NFC 操作・ユーザー登録モード実装                  |
| 13:32 | ユーザーカード PDF 生成の調査・プレビュー画像生成              |
| 13:40 | データモデリング: UserCostumes / CostumeBuilds テーブル追加    |
| 13:42 | oxfmt ignore ファイル設定（auto-generated ファイル除外）       |
| 13:44 | .oxfmtignore → .prettierignore リネーム（oxfmt 互換性修正）    |
| 13:46 | tRPC routers の修正（スキーマ変更への追従）                    |
| 13:47 | **PR #1 マージ**: データモデル追加（衣装所持・ビルドシステム） |

---

## 現在進行中のワークストリーム

Claude Code の git worktree を活用し、**5つの並列作業ブランチ**が存在:

### 1. `claude/data-modeling` — **完了・マージ済み**

PR #1 としてマージ完了。以下を実装:

- **UserCostumes テーブル**: ガチャで獲得した衣装の所持管理（userId + costumeId 複合キー、acquire 時に自動 count インクリメント）
- **CostumeBuilds テーブル**: top/bottom/accessory/hair の 4カテゴリ衣装組み合わせセット
- Costumes テーブルに `category` フィールドと `rarity-index` GSI 追加（Scan → Query に改善）
- Sessions を `costumeId` ベースから `buildId` ベースに変更、`score`/`rank` フィールド追加
- Users に `equippedBuildId` と `totalScore` 追加
- 全リポジトリ層の楽観的ロック対応

**ディスカッションポイント**: PRD では「衣装一覧」「衣装構築」が Must 機能として定義されていた。単純な costumeId 参照ではなく、4 カテゴリの「ビルド」概念を導入したのは、アイドルゲームらしい「コーデを組む」体験をデータ構造レベルで支えるため。

### 2. `claude/implement-admin-app` — **実装済み（未マージ）**

NFC 管理端末アプリの実装（+712 行）:

- **Operation モード** (`/`): NFC タグをスキャン → projector に SSE で通知
- **Register モード** (`/register`): NFC + QR コードの 2 ステップでカードとユーザーを紐付け
- `useNfc` hook: Web NFC API のラッパー（AbortController による安全なライフサイクル管理）
- `useQrScanner` hook: html5-qrcode ライブラリのラッパー
- Web NFC 型定義 (`web-nfc.d.ts`)

**検討の痕跡**: コード内に `// TODO: Replace with WebRTC response from projector` が複数箇所。当初の PRD では Socket.IO を想定していたリアルタイム通信だが、実装過程で tRPC SSE subscriptions に切り替えた。さらに WebRTC による双方向通信も検討中の模様。admin → projector の一方向通知は SSE で十分だが、projector → admin へのレスポンス（「このユーザーは表示したよ」等）には WebRTC が必要という判断が見える。

### 3. `claude/user-card` — **実装進行中**

NFC メンバーカードの印刷用 PDF 生成:

- 設計ドキュメント作成済み（`docs/plans/` に 2 ファイル）
- **packages/card** として独立パッケージ化（当初は packages/server 内に配置する計画だったが、変更）
- satori（JSX → SVG） → @resvg/resvg-js（SVG → PNG）のパイプライン実装済み
- カードデザイン: ピンク → パープルのグラデーション、星の装飾、「HACKZ / IDOL SYNTHESIS GAME」
- QR コード生成（`https://<MOBILE_URL>/login?nfcId=<cardId>` へのリンク）
- カード ID: 紛らわしい文字（0/O, 1/I/L）除外の 10 文字英数字
- **プレビュー画像生成済み**: A4 用紙に 2x4 = 8 枚配置のレイアウト確認完了

**設計上の面白い判断**: カードは「名刺サイズ（91mm x 55mm）」。これは偶然ではなく、ハッカソン会場で実際に印刷・裁断して NFC タグを裏面に貼り付けるための物理的制約から来ている。デジタルとフィジカルが交差するポイント。

**アーキテクチャ変更**: 実装計画では `packages/server/src/card/` に配置する予定だったが、実際には `packages/card/` として独立パッケージに変更された。これはサーバーの責務とカード生成（ビルドスクリプト）の責務を分離する判断。

### 4. `claude/investigate-dancing-video-generation` — **調査フェーズ**

コミットなし。PRD の「未確定事項」にある「動画合成の実装方法（FFmpeg.js / Three.js / サーバー側処理）」の調査用ブランチ。これはプロジェクトの核心機能（「え、自分がアイドルになってる」体験）に直結する最もリスクの高い技術課題。

### 5. `claude/webrtc-connections` — **調査フェーズ**

コミットなし。admin ↔ projector 間の双方向通信の実装調査用。

---

## アーキテクチャの進化（PRD → 実装）

PRD と実際のコードベースを比較すると、いくつかの重要な設計変更が見える:

### 通信方式の変遷

```
PRD:         Socket.IO（双方向）
  ↓
現在の実装:   tRPC SSE subscriptions（サーバー → クライアント）
             + tRPC mutations（クライアント → サーバー）
  ↓
検討中:      WebRTC（admin ↔ projector の直接 P2P 通信）
```

**なぜ Socket.IO をやめたか**: tRPC を全面採用したことで、型安全性を維持したまま SSE でリアルタイム通信ができるようになった。Socket.IO の「イベント名 = string」問題を回避。EventEmitter ベースの `ee.ts` でサーバー内部のイベント配信を実現。

### フレームワークの変遷

```
PRD:         TanStack Start（フルスタック）
  ↓
現在の実装:   Hono + tRPC（バックエンド）
             + React + Vite + TanStack Router（フロントエンド）
```

**なぜ TanStack Start をやめたか**: 3 つの異なるフロントエンド（mobile/admin/projector）が必要な構成では、フルスタックフレームワークよりも API サーバー + 個別 SPA の方が柔軟。tRPC で型安全性は担保。

---

## PRD 進捗マッピング

| PRD 機能            | 優先度       | 状態                                   |
| ------------------- | ------------ | -------------------------------------- |
| NFC 読み取り        | Must         | **実装済み**（admin アプリ）           |
| ユーザー認証        | Must         | **実装済み**（JWT, tRPC middleware）   |
| マイページ          | Must         | テンプレートに雛形あり、未着手         |
| ガチャ              | Must         | tRPC router あり、フロント未実装       |
| 写真アップロード    | Must         | tRPC router あり、フロント未実装       |
| 顔検出・合成        | Must         | **調査中**（dancing-video-generation） |
| ダンス動画表示      | Must         | **調査中**                             |
| 衣装一覧            | Must         | データモデル完了、フロント未実装       |
| 衣装構築            | Must         | データモデル完了、フロント未実装       |
| ノーツ＆スコア      | Should       | 未着手                                 |
| リザルト            | Should       | 未着手                                 |
| 3D モデルプレビュー | Nice to Have | 未着手                                 |

---

## 注目すべきエピソード・判断

### 1. 「並列開発」戦略

ハッカソン開始から約 2 時間半で、5 つの worktree を立ち上げて並列に作業を進めている。これは Claude Code の worktree 機能を最大限に活用した戦略。1 人の開発者が同時に複数の独立した作業を進められるのは、AI アシスタントとの協働ならではの開発スタイル。

### 2. 「物理カード」へのこだわり

PRD のビジョン「カードをかざす」を実現するために、PDF 生成スクリプトまで作り込んでいる。デジタルだけで完結させず、実際に印刷して NFC タグを貼る物理的な体験を重視。「え、自分がアイドルになってる」の驚きは、物理的なカードをタッチするところから始まるという設計思想。

### 3. PRD からの大胆な技術スタック変更

TanStack Start → Hono + tRPC、Socket.IO → SSE + WebRTC（検討中）と、PRD の技術選定から大きく舵を切っている。ただし PRD のビジョンと体験フローはそのまま。**What は変えず、How を現実に合わせた**好例。

### 4. 最大リスク: ダンス動画合成

PRD の核心機能でありながら、まだ調査フェーズ。「顔合成の処理時間：最大30秒」という制約の中で、Bedrock を使った顔検出 + 動画合成をどう実現するか。ここが最大の技術的チャレンジであり、ハッカソン成功の鍵。

---

## 次の時報までの見通し

- ダンス動画合成の技術検証結果が出るか
- admin アプリの PR マージ
- mobile アプリ（マイページ・ガチャ UI）の着手
- WebRTC 通信の方針決定

---

_このレポートは 2026/02/25 14:10 時点の git log、worktree 状態、コード内容、PRD から自動生成されました。_
